"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

const _ = require(`lodash`);

const crypto = require(`crypto`);

const path = require(`path`);

function onCreateNode(_x, _x2) {
  return _onCreateNode.apply(this, arguments);
}

function _onCreateNode() {
  _onCreateNode = (0, _asyncToGenerator2.default)(function* ({
    node,
    actions,
    loadNodeContent,
    createNodeId
  }, pluginOptions) {
    function getType({
      node,
      object,
      isArray
    }) {
      if (pluginOptions && _.isFunction(pluginOptions.typeName)) {
        return pluginOptions.typeName({
          node,
          object,
          isArray
        });
      } else if (pluginOptions && _.isString(pluginOptions.typeName)) {
        return pluginOptions.typeName;
      } else if (isArray) {
        return _.upperFirst(_.camelCase(`${node.name} Json`));
      } else {
        return _.upperFirst(_.camelCase(`${path.basename(node.dir)} Json`));
      }
    }

    function transformObject(obj, id, type) {
      const objStr = JSON.stringify(obj);
      const contentDigest = crypto.createHash(`md5`).update(objStr).digest(`hex`);
      const jsonNode = Object.assign({}, obj, {
        id,
        children: [],
        parent: node.id,
        internal: {
          contentDigest,
          type
        }
      });
      createNode(jsonNode);
      createParentChildLink({
        parent: node,
        child: jsonNode
      });
    }

    const createNode = actions.createNode,
          createParentChildLink = actions.createParentChildLink; // We only care about JSON content.

    if (node.internal.mediaType !== `application/json`) {
      return;
    }

    const content = yield loadNodeContent(node);
    const parsedContent = JSON.parse(content);

    if (_.isArray(parsedContent)) {
      parsedContent.forEach((obj, i) => {
        transformObject(obj, obj.id ? obj.id : createNodeId(`${node.id} [${i}] >>> JSON`), getType({
          node,
          object: obj,
          isArray: true
        }));
      });
    } else if (_.isPlainObject(parsedContent)) {
      transformObject(parsedContent, parsedContent.id ? parsedContent.id : createNodeId(`${node.id} >>> JSON`), getType({
        node,
        object: parsedContent,
        isArray: false
      }));
    }
  });
  return _onCreateNode.apply(this, arguments);
}

exports.onCreateNode = onCreateNode;